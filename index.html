<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AND FOR MY LAST TRICK – Wake Up</title>
<style>
  :root{--bg:#0b0f13;--panel:#121821;--ink:#e6edf3;--muted:#9aa4af;--accent:#20e3b2;--warn:#ff6b6b;--lock:#ffd166}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-monospace,Menlo,Consolas,monospace;background:radial-gradient(1200px 600px at 70% -10%,#0e1622 0%,#0b0f13 55%,#090c10 100%)}
  .wrap{max-width:900px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;gap:12px;color:var(--ink);margin:24px 0}
  .seal{width:46px;height:46px;border:2px solid var(--accent);border-radius:50%;display:grid;place-items:center;font-weight:700;color:var(--accent)}
  h1{font-size:24px;margin:0}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid #1f2937;border-radius:14px;padding:20px;color:var(--ink);backdrop-filter:blur(2px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:16px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input,button{width:100%;padding:12px 14px;background:#0f141b;border:1px solid #243043;border-radius:10px;color:var(--ink);outline:none}
  select:focus,input:focus{border-color:#335b99;box-shadow:0 0 0 3px rgba(51,91,153,.25)}
  button{background:linear-gradient(90deg,#123,#0f2);border:0;font-weight:700;cursor:pointer}
  button:hover{filter:brightness(1.15)}
  .hint{font-size:12px;color:var(--muted)}
  .err{color:var(--warn);font-size:13px;margin-top:8px}
  .ok{color:var(--accent)}
  .badge{display:inline-block;font-size:12px;color:#0c0;padding:3px 8px;border:1px solid #0c0;border-radius:999px}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .avatar{width:120px;height:120px;border-radius:12px;object-fit:cover;border:1px solid #1f2937;background:#0e131a}
  .mono{font-family:inherit;font-size:14px;color:var(--muted)}
  .list{margin:0;padding-left:18px}
  .divider{height:1px;background:#1f2937;margin:16px 0}
  .code{font-family:inherit;color:#9aff9a}
  .lock{color:var(--lock)}
  .hidden{display:none}
  .foot{margin-top:18px;font-size:12px;color:var(--muted)}
  /* Pattern lock */
  .pat-grid{user-select:none;touch-action:none;width:360px;max-width:92vw;aspect-ratio:1;border:1px solid #243043;border-radius:12px;margin:10px 0;display:grid;grid-template-columns:repeat(5,1fr);gap:14px;padding:14px;background:#0f141b;position:relative}
  .pat-node{border:1px solid #335b99;border-radius:50%;background:#0b0f13;position:relative}
  .pat-node.on{background:#173050;border-color:#20e3b2}
  .pat-canvas{position:absolute;inset:0;pointer-events:none}
  .shake{animation:shake .25s linear 1}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(6px)}50%{transform:translateX(-6px)}75%{transform:translateX(4px)}100%{transform:translateX(0)}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="seal">WA</div>
    <div>
      <h1>AND FOR MY LAST TRICK…</h1>
      <div class="mono">Agence Wake Up · Transmission prioritaire</div>
    </div>
  </header>

  <!-- Intro -->
  <section id="intro" class="card">
    <p><strong>Ordre de mission</strong> : identifiez-vous puis confirmez votre date d’arrivée à l’Agence.</p>
    <div class="grid">
      <div>
        <label for="agent">Je suis…</label>
        <select id="agent">
          <option value="" selected disabled>Choisir un agent</option>
          <option value="sam">Sam</option>
          <option value="camille">Camille</option>
          <option value="maxence">Maxence</option>
          <option value="juliette">Juliette</option>
          <option value="romane">Romane</option>
          <option value="clemence">Clémence</option>
          <option value="nat">Nat</option>
        </select>
      </div>
      <div>
        <label for="startDate">Date d’arrivée</label>
        <input id="startDate" type="text" placeholder="ex : 12/10/2023 · 12 octobre 2023 · 12 oct 23">
        <div class="hint">Accents tolérés. Formats FR/EN ok.</div>
      </div>
      <div>
        <button id="validate">Valider &gt; Dossier Agent</button>
        <div id="errIntro" class="err hidden">Date invalide pour cet agent.</div>
      </div>
    </div>
  </section>

  <!-- Profil + Quiz -->
  <section id="profile" class="card hidden">
    <div class="row">
      <img id="agentPhoto" class="avatar" alt="Photo Agent" src="">
      <div>
        <h2 id="agentTitle">Agent —</h2>
        <div class="mono" id="coverName">Nom de couverture : <span class="code">—</span></div>
        <div class="mono" id="seniority">Ancienneté : —</div>
        <div class="mono" id="spec">Spécialité : <span class="code">—</span></div>
      </div>
    </div>
    <div class="divider"></div>
    <h3>Interrogatoire de sécurité <span class="badge">3 questions</span></h3>
    <ol id="quiz" class="list"></ol>
    <button id="checkQuiz">Soumettre</button>
    <div id="quizMsg" class="err hidden"></div>
    <div id="reward" class="hidden">
      <div class="divider"></div>
      <h3 class="lock">Accès conditionnel accordé</h3>
      <p class="mono">Lieu de fouille pour <span id="who"></span> : <span id="digHint" class="code">—</span></p>
    </div>
    <button id="openPattern" class="hidden">Schéma (déverrouiller)</button>
  </section>

  <!-- Schéma -->
  <section id="pattern" class="card hidden">
    <h3>Schéma 5×5</h3>
    <div id="grid" class="pat-grid"></div>
    <div id="patMsg" class="err hidden"></div>
    <button id="toPlan" class="hidden">Valider le schéma &gt;</button>
  </section>

  <!-- Plan + Cloze -->
  <section id="plan" class="card hidden">
    <h3>Plan de l’accueil</h3>
    <img src="assets/plan-accueil.png" style="width:100%;max-width:700px;border:1px solid #1f2937;border-radius:10px">
    <div class="divider"></div>
    <p id="clozeText" class="mono"></p>
    <div class="row">
      <input id="clozeAnswer" type="text" placeholder="Réponse (ex: 750)">
      <button id="checkCloze">Valider</button>
    </div>
    <div id="clozeMsg" class="err hidden"></div>
  </section>

  <!-- Finale -->
  <section id="finale" class="card hidden">
    <h3>Rébus</h3>
    <img src="assets/rebus-bravo-agents.png" style="width:100%;max-width:700px;border:1px solid #1f2937;border-radius:10px">
    <p class="mono">Solution attendue : <span class="code">BRAVO AGENTS</span></p>
    <div class="divider"></div>
    <p class="code">Sous le panneau d’affichage, derrière le cadre noir.</p>
  </section>
</div>

<script>
/* === CONFIG === */
const AGENTS={sam:{label:"Sam",start:"2023-10-12",photo:"assets/sam.jpg",cover:"—",spec:"—",dig:"Sous le bureau du GM."},
camille:{label:"Camille",start:"2022-09-08",photo:"assets/camille.jpg",cover:"—",spec:"—",dig:"Sous le zip de la chaise n°2."},
maxence:{label:"Maxence",start:"2025-03-29",photo:"assets/maxence.jpg",cover:"—",spec:"—",dig:"Tiroir 3, salle préférée."},
juliette:{label:"Juliette",start:"2024-08-24",photo:"assets/juliette.jpg",cover:"—",spec:"—",dig:"Enveloppe sous le comptoir."},
romane:{label:"Romane",start:"2025-05-09",photo:"assets/romane.jpg",cover:"—",spec:"—",dig:"Derrière l’affiche de la salle."},
clemence:{label:"Clémence",start:"2025-05-09",photo:"assets/clemence.jpg",cover:"—",spec:"—",dig:"Sous la chaise n°4."},
nat:{label:"Nat",start:"2017-02-24",photo:"assets/nat.jpg",cover:"—",spec:"—",dig:"Bureau technique."}};

const QUESTION_BANK = [
  { q:"Date de création de l’Agence Wake Up ?", answers:["24/02/2017","24-02-2017","24 02 2017","24 fevrier 2017","24 février 2017","24 february 2017","feb 24 2017","2017-02-24"], norm:"2017-02-24" },
  { q:"Première salle ouverte à Wake Up ?", answers:["l'affaire blackwood","affaire blackwood","blackwood","laffaire blackwood"] },
  { q:"Quelle salle a été récompensée aux Escape Awards en 2019 ?", answers:["l'affaire blackwood","affaire blackwood","blackwood","laffaire blackwood"] },
  { q:"Nombre d’années de service de l’Agent A ?", answers:["6","six"] },
  { q:"Logiciel utilisé pour les plannings ?", answers:["4escape"] },
  { q:"Vrai ou Faux – Axomama est la déesse de la pomme de terre pour les Incas ?", answers:["vrai","true"] },
  { q:"Vrai ou Faux – Une joueuse s’est déjà cassé une dent dans Psychose ?", answers:["vrai","true"] },
  { q:"Vrai ou Faux – Un joueur a déjà fait pipi dans Inti Kancha ?", answers:["vrai","true"] },
  { q:"Vrai ou Faux – On a eu 3 demandes en mariage à l’Agence ?", answers:["vrai","true"] },
  { q:"Combien d’Agents au total ont été recrutés depuis le début de l’Agence ?", answers:["48"] },
  { q:"En quelle année est sorti le film Escape Room au cinéma ?", answers:["2019"] },
  { q:"Dans quelle salle es-tu propice à t’enfermer pendant ton rangement ?", answers:["protocole vegas","vegas"] },
  { q:"Quel est le pays de naissance des Escape Games ?", answers:["japon","japan"] },
  { q:"Quelle est la salle la plus réservée depuis l’ouverture de Wake Up ?", answers:["contagion"] },
  { q:"Qui a le cri le plus terrifiant de Wake Up ?", answers:["sam","agent sam","camille bahougne"] },
  { q:"Quelle est la salle la plus longue à ranger ?", answers:["l'affaire blackwood","affaire blackwood","blackwood","laffaire blackwood"] },
  { q:"Quelle est la salle où les joueurs pètent le plus ?", answers:["psychose"] },
  { q:"Dans quelle salle y a-t-il des thermos coupées en deux pour faire des charnières ?", answers:["protocole vegas","vegas"] },
  { q:"Quelle salle contient le plus de codes à chiffres ?", answers:["contagion"] },
  { q:"1er avril 2023, l’agent Victor a annoncé de fausses salles. Donne le nom d’une d’entre elles.", type:"select", options:["Protocole Vegan","Contafion","L’Affaire Blackpoule","Arthrose","ET et la plancha"], answers:["protocole vegan","contafion","l'affaire blackpoule","laffaire blackpoule","arthrose","et et la plancha","et la plancha"] }
];


const CLOZE_BY_AGENT={sam:"Complète : numéro { _ }",camille:"Code { _ }",maxence:"Procédure { _ }",juliette:"Bouton { _ }",romane:"Casier { _ }",clemence:"Scanner { _ }"};
const CLOZE_SOLUTION="750";
const SECRET_PATTERN = [1,2,7,6,11,12,17,18,23,24,19,14,9,8,3,4];


/* === OUTILS === */
const $=s=>document.querySelector(s);
function normalize(t){return (t||"").toLowerCase();}

/* === INTRO === */
$("#validate").onclick=()=>{
  const key=$("#agent").value, raw=$("#startDate").value;
  if(!key||!raw)return;
  if(!AGENTS[key])return;
  const iso=AGENTS[key].start;
  if(!raw.includes(iso.split("-")[0])&&!raw.includes("2017")&&!raw.includes("2022")&&!raw.includes("2023")&&!raw.includes("2024")&&!raw.includes("2025")){$("#errIntro").classList.remove("hidden");return;}
  $("#intro").classList.add("hidden"); loadProfile(key);
};

/* === PROFIL === */
function loadProfile(key){
  const A=AGENTS[key];
  $("#agentTitle").textContent="Agent "+A.label;
  $("#agentPhoto").src=A.photo;
  $("#who").textContent=A.label;
  $("#digHint").textContent=A.dig;
  const qs=[...QUESTION_BANK].sort(()=>Math.random()-0.5).slice(0,3);
  const list=$("#quiz"); list.innerHTML="";
  qs.forEach((it,i)=>{list.innerHTML+=`<li>${it.q}<br><input id="q${i}"></li>`;});
  $("#checkQuiz").onclick=()=>{
    let ok=true; qs.forEach((it,i)=>{const v=normalize($("#q"+i).value);if(!it.answers.some(a=>v.includes(a)))ok=false;});
    if(!ok){$("#quizMsg").textContent="Mauvaise réponse.";$("#quizMsg").classList.remove("hidden");return;}
    $("#quizMsg").textContent="Correct.";$("#quizMsg").classList.add("ok");
    $("#reward").classList.remove("hidden");
    $("#openPattern").classList.remove("hidden");
  };
  $("#profile").classList.remove("hidden");
  $("#openPattern").onclick=()=>{$("#profile").classList.add("hidden");$("#pattern").classList.remove("hidden");buildPattern(key);};
}

/* === PATTERN === */
function buildPattern(agent){
  const grid = document.getElementById('grid');
  const patMsg = document.getElementById('patMsg');
  const toPlan = document.getElementById('toPlan');

  grid.innerHTML = '';
  const nodes = [];
  for(let i=0;i<25;i++){
    const d=document.createElement('div');
    d.className='pat-node';
    d.dataset.idx=i;
    grid.appendChild(d);
    nodes.push(d);
  }

  const canvas=document.createElement('canvas');
  canvas.className='pat-canvas';
  grid.appendChild(canvas);
  const ctx=canvas.getContext('2d');

  function resize(){ canvas.width=grid.clientWidth; canvas.height=grid.clientHeight; }
  new ResizeObserver(resize).observe(grid);

  let active=false, path=[];
  function center(el){
    const r=el.getBoundingClientRect(), g=grid.getBoundingClientRect();
    return {x:r.left-g.left+r.width/2,y:r.top-g.top+r.height/2};
  }
  function clearDraw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    nodes.forEach(n=>n.classList.remove('on'));
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.lineWidth=3; ctx.strokeStyle='#20e3b2'; ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.beginPath();
    path.forEach((idx,k)=>{ const c=center(nodes[idx]); if(k===0) ctx.moveTo(c.x,c.y); else ctx.lineTo(c.x,c.y); });
    ctx.stroke();
    path.forEach(idx=>nodes[idx].classList.add('on'));
  }
  function idxFrom(ev){
    const t = (ev.target && ev.target.closest)? ev.target.closest('.pat-node') : null;
    return t ? +t.dataset.idx : -1;
  }
  function start(ev){ ev.preventDefault(); active=true; path=[]; clearDraw(); maybeAdd(ev); }
  function move(ev){ if(!active) return; maybeAdd(ev); }
  function end(){ if(!active) return; active=false; validate(); }

  function maybeAdd(ev){
    const i = idxFrom(ev);
    if(i<0) return;
    if(path[path.length-1]===i) return;
    path.push(i); draw();
  }

  // Souris
  grid.addEventListener('mousedown',start);
  grid.addEventListener('mousemove',move);
  window.addEventListener('mouseup',end);
  // Tactile
  // Tactile
grid.addEventListener('touchstart', e=>{
  e.preventDefault();
  const t = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
  start({target:t});
},{passive:false});

grid.addEventListener('touchmove', e=>{
  e.preventDefault();
  const t = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
  move({target:t});
},{passive:false});

grid.addEventListener('touchend', e=>{
  e.preventDefault();
  end();
},{passive:false});



/* === PLAN === */
function preparePlan(agent){
  $("#clozeText").textContent=CLOZE_BY_AGENT[agent].replace("{ _ }","_____");
  $("#checkCloze").onclick=()=>{if($("#clozeAnswer").value.trim()===CLOZE_SOLUTION){$("#plan").classList.add("hidden");$("#finale").classList.remove("hidden");}else{$("#clozeMsg").textContent="Mauvaise réponse.";$("#clozeMsg").classList.remove("hidden");}};
}
</script>
</body>
</html>
