<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>AND FOR MY LAST TRICK – Brief Agents</title>
<style>
  :root{--bg:#0b0f13;--panel:#121821;--ink:#e6edf3;--muted:#9aa4af;--accent:#20e3b2;--warn:#ff6b6b;--lock:#ffd166}
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-monospace,Menlo,Consolas,monospace;background:radial-gradient(1200px 600px at 70% -10%,#0e1622 0%,#0b0f13 55%,#090c10 100%)}
  .wrap{max-width:900px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;gap:12px;color:var(--ink);margin:24px 0}
  .seal{width:46px;height:46px;border:2px solid var(--accent);border-radius:50%;display:grid;place-items:center;font-weight:700;color:var(--accent)}
  h1{font-size:24px;margin:0}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));border:1px solid #1f2937;border-radius:14px;padding:20px;color:var(--ink);backdrop-filter:blur(2px);box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .grid{display:grid;gap:16px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  select,input,button{width:100%;padding:12px 14px;background:#0f141b;border:1px solid #243043;border-radius:10px;color:var(--ink);outline:none}
  select:focus,input:focus{border-color:#335b99;box-shadow:0 0 0 3px rgba(51,91,153,.25)}
  button{background:linear-gradient(90deg,#123,#0f2);border:0;font-weight:700;cursor:pointer}
  button:hover{filter:brightness(1.15)}
  .hint{font-size:12px;color:var(--muted)}
  .err{color:var(--warn);font-size:13px;margin-top:8px}
  .ok{color:#20e3b2}
  .badge{display:inline-block;font-size:12px;color:#0c0;padding:3px 8px;border:1px solid #0c0;border-radius:999px}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  .avatar{width:120px;height:120px;border-radius:12px;object-fit:cover;border:1px solid #1f2937;background:#0e131a}
  .mono{font-size:14px;color:var(--muted)}
  .list{margin:0;padding-left:18px}
  .divider{height:1px;background:#1f2937;margin:16px 0}
  .code{color:#9aff9a}
  .lock{color:var(--lock)}
  .hidden{display:none}
  /* Pattern lock */
  .pat-grid{user-select:none;touch-action:none;width:360px;max-width:92vw;aspect-ratio:1;border:1px solid #243043;border-radius:12px;margin:10px 0;display:grid;grid-template-columns:repeat(5,1fr);gap:14px;padding:14px;background:#0f141b;position:relative}
  .pat-node{border:1px solid #335b99;border-radius:50%;background:#0b0f13;position:relative}
  .pat-node.on{background:#173050;border-color:#20e3b2}
  .pat-canvas{position:absolute;inset:0;pointer-events:none}
  .shake{animation:shake .25s linear 1}
  @keyframes shake{0%{transform:translateX(0)}25%{transform:translateX(6px)}50%{transform:translateX(-6px)}75%{transform:translateX(4px)}100%{transform:translateX(0)}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="seal">WA</div>
    <div>
      <h1>AND FOR MY LAST TRICK…</h1>
      <div class="mono">Agence Wake Up · Transmission prioritaire</div>
    </div>
  </header>

  <!-- Écran 1 -->
  <section id="intro" class="card">
    <p><strong>Ordre de mission</strong> : identifiez-vous puis confirmez votre date d’arrivée à l’Agence.</p>
    <div class="grid">
      <div>
        <label for="agent">Je suis…</label>
        <select id="agent">
          <option value="" selected disabled>Choisir un agent</option>
          <option value="sam">Sam</option>
          <option value="camille">Camille</option>
          <option value="maxence">Maxence</option>
          <option value="juliette">Juliette</option>
          <option value="romane">Romane</option>
          <option value="clemence">Clémence</option>
          <option value="nat">Nat</option>
        </select>
      </div>
      <div>
        <label for="startDate">Date d’arrivée</label>
        <input id="startDate" type="text" placeholder="ex : 12/02/1999 · 12 fevrier 1999 · 12 fev 99">
        <div class="hint">Formats FR/EN ok. Accents tolérés.</div>
      </div>
      <div>
        <button id="validate">Valider &gt; Dossier Agent</button>
        <div id="errIntro" class="err hidden">Date invalide pour cet agent.</div>
      </div>
    </div>
  </section>

  <!-- Écran 2 -->
  <section id="profile" class="card hidden">
    <div class="row">
      <img id="agentPhoto" class="avatar" alt="Photo Agent" src="">
      <div>
        <h2 id="agentTitle">Agent —</h2>
        <div class="mono" id="coverName">Nom de couverture : <span class="code">—</span></div>
        <div class="mono" id="seniority">Ancienneté : —</div>
        <div class="mono" id="spec">Spécialité : <span class="code">—</span></div>
      </div>
    </div>
    <div class="divider"></div>
    <h3>Interrogatoire de sécurité <span class="badge">3 questions</span></h3>
    <ol id="quiz" class="list"></ol>
    <button id="checkQuiz">Soumettre</button>
    <div id="quizMsg" class="err hidden"></div>
    <div id="reward" class="hidden">
      <div class="divider"></div>
      <h3 class="lock">Accès conditionnel accordé</h3>
      <p class="mono">Lieu de fouille pour <span id="who"></span> : <span id="digHint" class="code">—</span></p>
    </div>
    <button id="openPattern" class="hidden">Schéma (déverrouiller)</button>
  </section>

  <!-- Écran 3 -->
  <section id="pattern" class="card hidden">
    <h3>Schéma 5×5</h3>
    <p class="mono">Trace la forme complète. Reste appuyé.</p>
    <div id="grid" class="pat-grid"></div>
    <div id="patMsg" class="err hidden"></div>
    <button id="toPlan" class="hidden">Valider le schéma &gt;</button>
  </section>

  <!-- Écran 4 -->
  <section id="plan" class="card hidden">
    <h3>Déplacements d’Agents</h3>
    <p class="mono">Tracez un trait droit d’un déplacement à l’autre, même si ça traverse les murs.Commencer un nouveau tracé pour chaque Agent. </p>
    <img src="assets/Plan.jpg" style="width:100%;max-width:700px;border:1px solid #1f2937;border-radius:10px">
    <div class="divider"></div>
    <p id="clozeText" class="mono"></p>
    <div class="row" style="gap:10px">
      <input id="clozeAnswer" type="text" placeholder="Entrez la réponse finale">
      <button id="checkCloze">Réponse</button>
    </div>
    <div id="clozeMsg" class="err hidden"></div>
  </section>

  <!-- Écran 5 -->
  <section id="finale" class="card hidden">
    <h3>Bravo Agents</h3>
    <p class="mono">Vous avez complété la mission.</p>
    <img src="assets/Last.jpg" style="width:100%;max-width:700px;border:1px solid #1f2937;border-radius:10px">
  </section>
</div>

<script>
/* === Données Agents (dates + spécialités) === */
const AGENTS = {
  sam:{label:"Sam",start:"2023-10-12",photo:"assets/sam.jpg",cover:"S.A.M",spec:"Créatrice de contenus hors norme & terreur de Wake Up",dig:"6ème emplacement du meuble à droite de la porte bureau GM"},
  camille:{label:"Camille",start:"2022-09-08",photo:"assets/camille.jpg",cover:"Miss Rey",spec:"Graphiste Phasme avec esprit vif, très cOnFiDeNtiEL",dig:"Dans l'ancien Carnet de Jane du local technique de ta salle pref"},
  maxence:{label:"Maxence",start:"2025-03-29",photo:"assets/maxence.jpg",cover:"M.A.X",spec:"Futur Spielberg moderne, dit souvent AGENT C'EST CHARLES",dig:"Trousse de secours"},
  juliette:{label:"Juliette",start:"2024-08-24",photo:"assets/juliette.jpg",cover:"Juju",spec:"Spécialiste sous couverture...Maline..trop maline..",dig:"Dans un des canapés carrés"},
  romane:{label:"Romane",start:"2025-05-09",photo:"assets/romane.jpg",cover:"Roro",spec:"Bout en train, Répartie aiguisée comme un couteau et metteuse d'ambiance",dig:"Dans la grosse cafetière de la réserve"},
  clemence:{label:"Clémence",start:"2025-05-09",photo:"assets/clemence.jpg",cover:"C.L.E.M",spec:"Spécialiste des interventions Psychose et des rébus sur post it",dig:"Dans le tiroir à lunettes coeurs dans le bureau GM"},
  nat:{label:"Nat",start:"2017-02-24",photo:"assets/nat.jpg",cover:"Cheffe",spec:"Point fort : cerveau de l'opération · Point faible : les margaritas",dig:"Dans un casier de ton bureau"}
};

/* === Textes à trous / Banques de mots par binômes === */
const CLOZE_TEXTS = {
  // Duo 1 : Romane ↔ Maxence
  romane:  "Agent Romane arrive toujours la première. Après avoir ouvert la _____, elle ouvre également la porte de _____ la plus proche. Ensuite elle va se servir un verre d’_____ avant de _____ sa journée.",
  maxence: "Mots à placer : porte principale · secours · eau · commencer",

  // Duo 2 : Sam ↔ Clémence
  sam:     "L’Agent Sam va directement allumer la _____ près du _____ de l’accueil, puis se chercher une _____ dans le _____ avant de vérifier les _____ sur les tables, celle proche du _____ d’abord bien sûr !",
  clemence:"Mots à placer : lumière · coffre · boisson énergisante · frigo · flyers · néon",

  // Duo 3 : Camille ↔ Juliette
  camille: "L’Agent Camille arrive en dernière, fait un _____ à _____, puis allume l’_____ dans le _____ de sa salle préférée. Elle ouvre la _____ de la future salle de réunion et _____ le _____. Elle se souvient qu’elle a oublié de demander à _____ comment s’étaient passées ses _____, et _____ lui parler.",
  juliette:"Mots à placer : coucou · Nat · ordinateur · local · porte · arrose · jardin · vacances · retourne",

  // Nat à part
  nat:     "Brief spécial. Voir le maître du jeu."
};

/* === Banque de questions === */
const QUESTION_BANK = [
  {q:"Date de création de l’Agence Wake Up ? Format jour mois année",answers:["24/02/2017","24-02-2017","24 02 2017","24 fevrier 2017","24 février 2017","24 february 2017","feb 24 2017","2017-02-24"],norm:"2017-02-24"},
  {q:"Première salle ouverte à Wake Up ?",answers:["l'affaire blackwood","affaire blackwood","blackwood","laffaire blackwood", "AB", "ab"]},
  {q:"Quelle salle a été récompensée aux Escape Awards en 2019 ?",answers:["l'affaire blackwood","affaire blackwood","blackwood","laffaire blackwood","AB", "ab"]},
  {q:"Nombre d’années de service de l’Agent A ?",answers:["6","six"]},
  {q:"Logiciel utilisé pour les plannings ?",answers:["4escape"]},
  {q:"Vrai ou Faux – Axomama est la déesse de la pomme de terre pour les Incas ?",answers:["vrai","true"]},
  {q:"Vrai ou Faux – Une joueuse s’est déjà cassé une dent dans Psychose ?",answers:["vrai","true"]},
  {q:"Vrai ou Faux – Un joueur a déjà fait pipi dans Inti Kancha ?",answers:["vrai","true"]},
  {q:"Vrai ou Faux – On a eu au moins 3 demandes en mariage à l’Agence ?",answers:["vrai","true"]},
  {q:"Combien d’Agents au total ont été recrutés depuis le début de l’Agence ? L'Agent Natacha détient l'information précise",answers:["48"]},
  {q:"Quelle mission a Agent A joué pour de son entretien d'embauche ?",answers:["l'affaire blackwood","affaire blackwood","blackwood","laffaire blackwood","AB", "ab"]},
  {q:"En quelle année est sorti le film Escape Room au cinéma ?",answers:["2019"]},
  {q:"Dans quelle salle es-tu propice à t’enfermer pendant ton rangement ?",answers:["protocole vegas","vegas", "PV","pv"]},
  {q:"Quel est le pays de naissance des Escape Games ?",answers:["japon","japan","Japon"]},
  {q:"Quelle est la salle la plus réservée depuis l’ouverture de Wake Up ?",answers:["contagion","Contagion","Conta"]},
  {q:"Qui a le cri le plus terrifiant de Wake Up ?",answers:["sam","agent sam","camille bahougne"]},
  {q:"Quelle est la salle la plus longue à ranger ?",answers:["l'affaire blackwood","affaire blackwood","blackwood","laffaire blackwood","AB","ab"]},
  {q:"Quelle est la salle où les joueurs pètent le plus ?",answers:["psychose","Psychose"]},
  {q:"Dans quelle salle y a-t-il des thermos coupées en deux pour faire des charnières sur le coffre géant ?",answers:["protocole vegas","vegas","PV","pv"]},
  {q:"Quelle salle contient le plus de codes à chiffres ?",answers:["contagion","Contagion","Conta","conta"]},
  {q:"1er avril 2023, l’agent Victor a annoncé de fausses salles. Donne le nom d’une d’entre elles.",answers:["protocole vegan","contafion","l'affaire blackpoule","laffaire blackpoule","arthrose","et et la plancha","et la plancha"]}
];

/* === Pattern secret (sans le 0 final) === */
const SECRET_PATTERN=[1,2,7,6,11,12,17,18,23,24,19,14,9,8,3,4];

/* === Parsing de dates souple FR/EN === */
const MONTHS={"janvier":1,"fevrier":2,"février":2,"february":2,"mars":3,"avril":4,"mai":5,"juin":6,"juillet":7,"aout":8,"août":8,"august":8,"septembre":9,"octobre":10,"novembre":11,"decembre":12,"décembre":12,"december":12,"jan":1,"feb":2,"fev":2,"fév":2,"mar":3,"apr":4,"avr":4,"may":5,"jun":6,"jul":7,"aug":8,"sep":9,"sept":9,"oct":10,"nov":11,"dec":12,"déc":12};
function normalize(s){return (s||"").toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').replace(/[^a-z0-9\s\/\-\.,]/g,' ').replace(/\s+/g,' ').trim();}
function isoOrNull(Y,M,D){const dt=new Date(Date.UTC(+Y,+M-1,+D));return(dt.getUTCFullYear()==Y&&dt.getUTCMonth()==M-1&&dt.getUTCDate()==D)?`${String(Y).padStart(4,'0')}-${String(M).padStart(2,'0')}-${String(D).padStart(2,'0')}`:null;}
function parseFlexibleDate(input){
  const s=normalize(input);let m;
  if((m=s.match(/^(\d{4})[\/\-. ](\d{1,2})[\/\-. ](\d{1,2})$/))){const[_,Y,M,D]=m;return isoOrNull(+Y,+M,+D);}
  if((m=s.match(/^(\d{1,2})[\/\-. ](\d{1,2})[\/\-. ](\d{2,4})$/))){let[_,D,M,Y]=m;if(Y.length===2)Y=String(2000+ +Y);return isoOrNull(+Y,+M,+D);}
  if((m=s.match(/^(\d{1,2}) ([a-z\.]+) (\d{2,4})$/))){let[_,D,mon,Y]=m;mon=mon.replace(/\./g,'');if(Y.length===2)Y=String(2000+ +Y);const M=MONTHS[mon];if(!M)return null;return isoOrNull(+Y,+M,+D);}
  if((m=s.match(/^([a-z\.]+) (\d{1,2}) (\d{2,4})$/))){let[_,mon,D,Y]=m;mon=mon.replace(/\./g,'');if(Y.length===2)Y=String(2000+ +Y);const M=MONTHS[mon];if(!M)return null;return isoOrNull(+Y,+M,+D);}
  return null;
}

/* === UI === */
const $=s=>document.querySelector(s);
const errIntro=$("#errIntro");
$("#validate").onclick=()=>{
  const key=$("#agent").value, raw=$("#startDate").value;
  if(!key||!raw){err("Choisis un agent et une date.");return;}
  const iso=parseFlexibleDate(raw);
  if(!iso||iso!==AGENTS[key].start){err("Date invalide pour cet agent.");return;}
  errIntro.classList.add("hidden");
  loadProfile(key);
};
function err(t){errIntro.textContent=t;errIntro.classList.remove("hidden");}

/* === Profil + Quiz === */
function loadProfile(key){
  const A=AGENTS[key];
  $("#agentTitle").textContent=`Agent ${A.label}`;
  $("#agentPhoto").src=A.photo;
  $("#coverName").innerHTML=`Nom de couverture : <span class="code">${A.cover}</span>`;
  $("#spec").innerHTML=`Spécialité : <span class="code">${A.spec}</span>`;
  $("#seniority").textContent="Ancienneté : "+seniorityFrom(A.start);
  $("#who").textContent=A.label;
  $("#digHint").textContent=A.dig;

  const pool=shuffle(QUESTION_BANK.slice());
  const picked=pool.slice(0,3);
  const list=$("#quiz"); list.innerHTML="";
  picked.forEach((item,idx)=>{
    list.insertAdjacentHTML("beforeend",
      `<li><div style="margin-bottom:6px">${item.q}</div>
        <input type="text" id="q_${idx}" placeholder="Votre réponse">
        <div class="hint">Accents/majuscules ignorés.</div></li>`);
  });

  $("#checkQuiz").onclick=()=>{
    const ok=picked.every((item,idx)=>{
      const val=normalize($("#q_"+idx).value);
      if(!val) return false;
      if(item.norm){const iso=parseFlexibleDate(val);return iso===item.norm;}
      return item.answers.some(a=>normalize(a)===val);
    });
    const msg=$("#quizMsg");
    if(!ok){msg.textContent="Mauvaise réponse.";msg.classList.remove("hidden");msg.classList.remove("ok");return;}
    msg.textContent="Correct. Lieu de fouille débloqué.";msg.classList.remove("hidden");msg.classList.add("ok");
    $("#reward").classList.remove("hidden");
    document.getElementById("openPattern").classList.remove("hidden");
  };

  document.getElementById("intro").classList.add("hidden");
  document.getElementById("profile").classList.remove("hidden");

  document.getElementById("openPattern").onclick=()=>{
    document.getElementById("profile").classList.add("hidden");
    document.getElementById("pattern").classList.remove("hidden");
    buildPattern(key);
  };
}
function seniorityFrom(iso){const s=new Date(iso+"T00:00:00Z"),n=new Date();let y=n.getUTCFullYear()-s.getUTCFullYear(),m=n.getUTCMonth()-s.getUTCMonth(),d=n.getUTCDate()-s.getUTCDate();if(d<0)m--;if(m<0){y--;m+=12;}return `${y} an${y>1?'s':''} ${m} mois`;}
function shuffle(a){for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

/* === Pattern 5×5 (mobile + desktop) === */
function buildPattern(agent){
  const grid=document.getElementById('grid');
  const patMsg=document.getElementById('patMsg');
  const toPlan=document.getElementById('toPlan');

  grid.innerHTML=''; const nodes=[];
  for(let i=0;i<25;i++){const d=document.createElement('div');d.className='pat-node';d.dataset.idx=i;grid.appendChild(d);nodes.push(d);}

  const canvas=document.createElement('canvas');canvas.className='pat-canvas';grid.appendChild(canvas);
  const ctx=canvas.getContext('2d');
  function resize(){const r=grid.getBoundingClientRect();canvas.width=r.width;canvas.height=r.height;}
  new ResizeObserver(resize).observe(grid); resize();

  let active=false, path=[];
  function center(el){const r=el.getBoundingClientRect(),g=grid.getBoundingClientRect();return {x:r.left-g.left+r.width/2,y:r.top-g.top+r.height/2};}
  function clearDraw(){ctx.clearRect(0,0,canvas.width,canvas.height);nodes.forEach(n=>n.classList.remove('on'));}
  function draw(){ctx.clearRect(0,0,canvas.width,canvas.height);ctx.lineWidth=3;ctx.strokeStyle='#20e3b2';ctx.lineJoin='round';ctx.lineCap='round';ctx.beginPath();path.forEach((idx,k)=>{const c=center(nodes[idx]);if(k===0)ctx.moveTo(c.x,c.y);else ctx.lineTo(c.x,c.y);});ctx.stroke();path.forEach(i=>nodes[i].classList.add('on'));}
  function idxFromTarget(t){const n=t&&t.closest?t.closest('.pat-node'):null;return n?+n.dataset.idx:-1;}
  function startFromTarget(t){active=true;path=[];clearDraw();maybeAddTarget(t);}
  function moveFromTarget(t){if(!active)return;maybeAddTarget(t);}
  function endStroke(){if(!active)return;active=false;validate();}
  function maybeAddTarget(t){const idx=idxFromTarget(t);if(idx<0)return;if(path[path.length-1]===idx)return;path.push(idx);draw();}

  grid.addEventListener('mousedown',e=>{e.preventDefault();startFromTarget(e.target);});
  grid.addEventListener('mousemove',e=>{moveFromTarget(e.target);});
  window.addEventListener('mouseup',()=>endStroke());

  grid.addEventListener('touchstart',e=>{e.preventDefault();const t=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);startFromTarget(t);},{passive:false});
  grid.addEventListener('touchmove',e=>{e.preventDefault();const t=document.elementFromPoint(e.touches[0].clientX,e.touches[0].clientY);moveFromTarget(t);},{passive:false});
  grid.addEventListener('touchend',e=>{e.preventDefault();endStroke();},{passive:false});

  function normalizePath(a){const out=[];for(const v of a){if(out[out.length-1]!==v)out.push(v);}return out;}
  function same(a,b){if(a.length!==b.length)return false;for(let i=0;i<a.length;i++)if(a[i]!==b[i])return false;return true;}

  function validate(){
    const ok=same(normalizePath(path),SECRET_PATTERN);
    if(!ok){patMsg.textContent="Schéma non validé. Réessaie.";patMsg.classList.remove('hidden');patMsg.classList.remove('ok');grid.classList.add('shake');setTimeout(()=>grid.classList.remove('shake'),250);clearDraw();path=[];return;}
    patMsg.textContent="Schéma validé.";patMsg.classList.remove('hidden');patMsg.classList.add('ok');toPlan.classList.remove('hidden');
  }
  toPlan.onclick=()=>{ preparePlan(agent); };
}

/* === Plan + Validation (code attendu 750) === */
function preparePlan(agent){
  document.getElementById("pattern").classList.add("hidden");
  document.getElementById("plan").classList.remove("hidden");
  document.getElementById("clozeText").textContent = CLOZE_TEXTS[agent] || "Aucun texte défini.";

  const msg = document.getElementById("clozeMsg");
  document.getElementById("checkCloze").onclick = ()=>{
    const v = (document.getElementById("clozeAnswer").value||"").trim().toLowerCase();
    if(v === "750"){
      document.getElementById("plan").classList.add("hidden");
      document.getElementById("finale").classList.remove("hidden");
    } else {
      msg.textContent = "Mauvaise réponse.";
      msg.classList.remove("hidden");
    }
  };
}
</script>
</body>
</html>
